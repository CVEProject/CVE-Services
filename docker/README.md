# Using Docker with cve-services

## Setup for Local Development

Use the following steps to build and run cve-services (Node.js app
and Mongo) in docker containers.  Note that the current configuration is
set to run the services in development mode. Note that these commands
must be run from the `docker/` directory.

The docker setup uses an environment defined in `docker/.docker-env.example`
but `docker-compose` looks for this file at `docker/.docker-env`.  The
`docker/.docker-env` file is ignored by our `.gitignore`. This is a
safeguard against developers committing changes to their local docker
environment.

1. Create your environment file if it doesn't already exist:
  `cp .docker-env.example .docker-env`
2. Login to docker using your GitHub username and Personal Access Token 
   (PAT). If you don't have a PAT you can quickly create one by following
   the instructions in [Creating a token](https://docs.github.com/en/github/authenticating-to-github/keeping-your-account-and-data-secure/creating-a-personal-access-token#creating-a-token).
   You should c/p your token in a file and keep it safe. 

   > Note: Make sure the GitHub token you use (or the one you created) has the
    `read:packages` permission so that you can pull packages from the GitHub 
    Package Registry.

   Login to docker using your GitHub username and PAT by piping your PAT to 
   the docker login command:
   `cat ~/github_token.txt | docker login docker.pkg.github.com --username <github_username> --password-stdin`

   or login to docker by directly c/p your PAT to the docker login command:
   `docker login docker.pkg.github.com --username <github_username> --password-stdin <github_token_not_password>`    
3. Pull the lates images from [cveservices](https://github.com/orgs/CVEProject/packages?repo_name=cve-services) package:
  `docker pull docker.pkg.github.com/cveproject/cve-services/cveservices-dev:latest` or `docker pull docker.pkg.github.com/cveproject/cve-services/cveservices-staging:latest`
4. Run the containers:
  `docker-compose up`

## Setup for Local Penetration Testing

1. Change to the "staging" branch (this branch is used for the public testing instance):
  `git checkout staging`

1. Create your environment file if it doesn't already exist:
  `cp .docker-env.staging-example .docker-env`

2. Run the containers (this will also build the cveawg container from the included Dockerfile):
  `docker-compose up`

3. Populate mongoDB with test data included in "datadump/pre-population/":
  `docker-compose exec cveawg npm run populate:stage`

4. Retrieve the API Key (secret) for test user is stored in “user-secret.txt”
  `docker-compose exec cveawg cat user-secret.txt | grep admin2` \
  Should return: {"username":"admin2@mitre.org","secret":"API_KEY"}

5. Use curl to test the API (be sure to include the correct API_KEY returned in step #5):
  `curl -v http://localhost:3000/api/cve-id \
     -H "CVE-API-ORG: mitre" \
     -H "CVE-API-USER: admin2@mitre.org" \
     -H "CVE-API-KEY: API_KEY"`

## Try It Out

To make a REST request to the running CVE services, use the following
`curl` command:

  `curl http://localhost:3000/api/cna`

The result should be an empty JSON array (since there are no CNAs in
the database yet):

  []

## To shell into the web app server

  `docker-compose exec cveawg /bin/sh`

## To use curl to add a CNA

  `curl -X POST -H "Content-Type: application/json" \
     -d '{"name": "MITRE Corporation","short_name": "mitre"}' \
     http://localhost:3000/api/cna`

## Using Mongo Express

You can use [Mongo Express](https://github.com/mongo-express/mongo-express)
(a mongo web UI) to view mongo from your browser.
To start Mongo Express you can start it with the following command:

  `docker run --network docker_cve-services -e ME_CONFIG_MONGODB_SERVER=docdb -p 8081:8081 mongo-express`

You can use Mongo Express to view the Mongo data by using the
following URL and viewing the *cve_dev* database:

  <http://localhost:8081/>
