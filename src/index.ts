require('dotenv').config();
import * as debug from 'debug';
import * as http from 'http';
import * as express from 'express';
import { configMiddleware } from './middleware/config';
import { configureRoutes } from './routes/config';
import * as logger from 'morgan';
import * as helmet from 'helmet';
import * as morgan from 'morgan';
import 'reflect-metadata';
import { createConnection } from 'typeorm';
import { entities } from './database';
import { DB } from './constants';

export const app = express();

const SYNC_FLAG = true;

createConnection({
    type: 'mysql',
    host: DB.HOST,
    port: +DB.PORT,
    username: DB.USER,
    password: DB.PASS,
    database: DB.NAME,
    synchronize: SYNC_FLAG,
    dropSchema: true,
    logging: true,
    entities: [...entities],
})
    .then(async connection => {
        (function startServer() {
            if (process.env.NODE_ENV === 'prod' || process.env.NODE_ENV === 'qa') {
                //add analytics and logger
                app.use(logger('combined'));
            }
            //app.use(helmet());
           // app.use(morgan('tiny'));
            //configMiddleware(app);
            configureRoutes(app);
            const server = http.createServer(app);

            debug('ts-express:server');
            const port = process.env.PORT || 3001;
            console.log(`
        ----------------------STARTING SERVER----------------------
        PORT: ${port}
        ENVIRONMENT: ${process.env.NODE_ENV}
        `);
            app.set('port', port);
            server.listen(port);
        })();
    })
    .catch(error => {
        console.log(`Error while connecting to db ${DB.NAME}@${DB.HOST}:${DB.PORT}`);
        console.log(error);
    });
